stages:
    - pre
    - download
    - build
    - distrib

builder:
    stage: pre
    image: docker
    services:
        - name: docker:dind
          alias: docker
    script:
        - docker pull ${CI_REGISTRY_IMAGE}/builder
        - docker build --cache-from ${CI_REGISTRY_IMAGE}/builder -t ${CI_REGISTRY_IMAGE}/builder .
        - docker push ${CI_REGISTRY_IMAGE}/builder

download:
    stage: download
    image: ubuntu
    script:
        - ./download.sh
    artifacts:
        paths:
            - Downloads
            - flatRepo

build:
    stage: build
    image: ${CI_REGISTRY_IMAGE}/builder
    variables:
        GIT_SUBMODULE_STRATEGY: recursive
    script:
        - unzip Downloads/gradle*.zip
        - cd gradle*
        - ./bin/gradle yajswDevUnpack buildGhidra cdtUnpack pyDevUnpack
    artifacts:
        paths:
            - ghidra
            - ghidra.bin
